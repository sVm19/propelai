version: '3.8'

services:
  # 1. THE FASTAPI APPLICATION SERVICE (Tier 2)
  app:
    # Build the image using the Dockerfile in the current directory
    build: .

    # Map port 8000 on your local machine to port 8000 inside the container
    ports:
      - "8000:8000"

    # Load environment variables from the .env file in the root
    env_file:
      - .env

    # Restart the container automatically if it crashes
    restart: always

    # Make the app wait for the database service to be healthy before starting
    depends_on:
      db:
        condition: service_healthy

    # Mount the source code for hot-reloading (helpful during development)
    volumes:
      - ./main.py:/app/main.py
      - ./src:/app/src

  # 2. THE POSTGRES DATABASE SERVICE (Tier 3)
  db:
    # Use the official Postgres image
    image: postgres:14-alpine

    # Load database credentials securely from the .env file
    env_file:
      - .env

    # Map port 5432 on your machine to the container's port 5432
    ports:
      - "5432:5432"

    # Persist the data in a volume so it isn't lost when the container stops
    volumes:
      - postgres_data:/var/lib/postgresql/data/

    # Define a health check for the app service to depend on
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 5s
      timeout: 5s
      retries: 5

# Docker Volumes for data persistence
volumes:
  postgres_data:
